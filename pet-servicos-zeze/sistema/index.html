<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pet Serviços Zezé — Módulo Financeiro</title>
<style>
:root{--bg:#f7fafc;--card:#fff;--accent:#2b6cb0;--muted:#666}
body{font-family:Inter,Arial;margin:0;background:var(--bg);color:#222}
.container{max-width:1100px;margin:20px auto;padding:16px}
.card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,0.06);}
.row{display:flex;gap:12px;align-items:center}
input,select,textarea,button{padding:8px;border-radius:8px;border:1px solid #e6e6e6}
.btn{background:var(--accent);color:white;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
.btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(43,108,176,0.12)}
.hidden{display:none}
.table{width:100%;border-collapse:collapse;margin-top:12px}
.table th,.table td{padding:8px;border-bottom:1px solid #f0f0f0;text-align:left}
.small{font-size:13px;color:var(--muted)}
.invoice-box{border:1px solid #eee;padding:12px;border-radius:8px;background:#fff}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <h2>Pet Serviços Zezé — Módulo Financeiro</h2>
    <p class="small">Entrega: Unidade 2 — Faturas, Pagamentos e Comprovantes (prova de conceito com localStorage)</p>
    <div style="margin-top:8px" class="row">
      <button class="btn" id="btn-home">Home</button>
      <button class="btn ghost" id="btn-login-admin">Login Admin</button>
      <button class="btn ghost" id="btn-login-finance">Login Financeiro</button>
      <button class="btn ghost" id="btn-login-user">Login Cliente</button>
      <div style="margin-left:auto"><span id="current-role" class="small">(não logado)</span></div>
    </div>
  </div>

  <!-- HOME -->
  <div id="home" class="card" style="margin-top:14px">
    <h3>Início</h3>
    <p class="small">Use os botões acima para logar com papéis de teste e acessar o módulo financeiro.</p>
    <ul>
      <li>admin / 1234 (gerente)</li>
      <li>financeiro / 123456 (financeiro)</li>
      <li>cliente / 1234 (cliente)</li>
    </ul>
  </div>

  <!-- FINANCE DASHBOARD -->
  <div id="finance-dashboard" class="card hidden" style="margin-top:14px">
    <div class="row">
      <h3>Painel Financeiro</h3>
      <div style="margin-left:auto">
        <button class="btn" id="btn-new-invoice">Nova Fatura</button>
        <button class="btn ghost" id="btn-export-csv">Exportar CSV</button>
      </div>
    </div>

    <div style="margin-top:12px">
      <h4>Estatísticas</h4>
      <div class="row">
        <div class="invoice-box">Receita Total: <strong id="stat-revenue">R$ 0,00</strong></div>
        <div class="invoice-box">Despesas: <strong id="stat-expense">R$ 0,00</strong></div>
        <div class="invoice-box">Saldo: <strong id="stat-balance">R$ 0,00</strong></div>
      </div>
    </div>

    <div style="margin-top:12px">
      <h4>Faturas</h4>
      <table class="table" id="table-invoices">
        <thead><tr><th>ID</th><th>Cliente</th><th>Valor</th><th>Status</th><th>Vencimento</th><th>Ações</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- CREATE INVOICE -->
  <div id="create-invoice" class="card hidden" style="margin-top:14px">
    <h3>Criar Fatura</h3>
    <div style="margin-top:8px">
      <label>Cliente (username)</label>
      <input id="ci-username" placeholder="username do cliente">
    </div>
    <div style="margin-top:8px">
      <label>Descrição / Serviço</label>
      <input id="ci-desc" placeholder="Banho e Tosa">
    </div>
    <div style="margin-top:8px">
      <label>Valor (R$)</label>
      <input id="ci-amount" placeholder="120.00" type="number" step="0.01">
    </div>
    <div style="margin-top:8px">
      <label>Vencimento</label>
      <input id="ci-due" type="date">
    </div>
    <div style="margin-top:10px" class="row">
      <button class="btn" id="ci-save">Salvar Fatura</button>
      <button class="btn ghost" id="ci-cancel">Cancelar</button>
    </div>
  </div>

  <!-- VIEW INVOICE / PAYMENT -->
  <div id="view-invoice" class="card hidden" style="margin-top:14px">
    <div class="row">
      <h3>Fatura <span id="vi-id"></span></h3>
      <div style="margin-left:auto">
        <button class="btn" id="vi-print">Imprimir / Gerar PDF</button>
      </div>
    </div>
    <div style="margin-top:12px">
      <div id="vi-body" class="invoice-box"></div>
      <div style="margin-top:8px">
        <label>Método de Pagamento</label>
        <select id="vi-method">
          <option value="cartao">Cartão</option>
          <option value="boleto">Boleto</option>
          <option value="pix">PIX</option>
          <option value="dinheiro">Dinheiro</option>
        </select>
      </div>
      <div style="margin-top:8px" class="row">
        <button class="btn" id="vi-pay">Registrar Pagamento</button>
        <button class="btn ghost" id="vi-back">Voltar</button>
      </div>
    </div>
  </div>

  <!-- RECEIPT / COMPROVANTE (impressão) -->
  <div id="receipt-print-area" class="hidden"></div>

</div>

<script>
// ======== Storage keys e util =====const
const LS_USERS='pz_users_v2';
const LS_INVOICES='pz_invoices_v2';
const LS_PAYMENTS='pz_payments_v2';

function uid(){return 'id_'+Math.random().toString(36).slice(2,9)}
function formatBR(n){ return Number(n).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }

// ======== Inicialização: criar contas e dados de exemplo ========
function initData(){
  if(!localStorage.getItem(LS_USERS)){
    const users=[
      {id:uid(),username:'admin',name:'Administrador',password:'1234',role:'admin'},
      {id:uid(),username:'financeiro',name:'Financeiro',password:'123456',role:'finance'},
      {id:uid(),username:'cliente',name:'Cliente Teste',password:'1234',role:'user'},
    ];
    localStorage.setItem(LS_USERS,JSON.stringify(users));
  }
  if(!localStorage.getItem(LS_INVOICES)) localStorage.setItem(LS_INVOICES,JSON.stringify([]));
  if(!localStorage.getItem(LS_PAYMENTS)) localStorage.setItem(LS_PAYMENTS,JSON.stringify([]));
}
initData();

function getUsers(){return JSON.parse(localStorage.getItem(LS_USERS) || '[]');}
function getInvoices(){return JSON.parse(localStorage.getItem(LS_INVOICES) || '[]');}
function getPayments(){return JSON.parse(localStorage.getItem(LS_PAYMENTS) || '[]');}
function saveInvoices(arr){localStorage.setItem(LS_INVOICES,JSON.stringify(arr));}
function savePayments(arr){localStorage.setItem(LS_PAYMENTS,JSON.stringify(arr));}

// ======== Estado da sessão (simples) ========
let currentUser = null; // {username, role}
function setCurrent(u){ currentUser=u; document.getElementById('current-role').innerText = u? (u.role+' — '+u.username) : '(não logado)'; }

// Login via botões (simplificado para entrega)
document.getElementById('btn-login-admin').addEventListener('click', ()=>simpleLogin('admin','1234'));
document.getElementById('btn-login-finance').addEventListener('click', ()=>simpleLogin('financeiro','123456'));
document.getElementById('btn-login-user').addEventListener('click', ()=>simpleLogin('cliente','1234'));
function simpleLogin(username, password){
  const u = getUsers().find(x=>x.username===username && x.password===password);
  if(!u){ alert('Credenciais inválidas'); return; }
  setCurrent({username:u.username,role:u.role}); showDashboardForRole();
}

// Navegação
document.getElementById('btn-home').addEventListener('click', ()=>{ hideAll(); document.getElementById('home').classList.remove('hidden'); });

function hideAll(){ document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden')); }

// Mostrar dashboard conforme role
function showDashboardForRole(){ hideAll(); if(!currentUser){ document.getElementById('home').classList.remove('hidden'); return; }
  if(currentUser.role==='finance' || currentUser.role==='admin'){
    document.getElementById('finance-dashboard').classList.remove('hidden'); renderInvoicesTable(); renderStats();
  } else {
    // cliente
    document.getElementById('home').classList.remove('hidden'); alert('Acesso como cliente: use o botão "Ver minhas faturas" (não implementado como rota separada nesta prova de conceito)');
  }
}

// Criar fatura
document.getElementById('btn-new-invoice').addEventListener('click', ()=>{ hideAll(); document.getElementById('create-invoice').classList.remove('hidden'); });
document.getElementById('ci-cancel').addEventListener('click', ()=>{ hideAll(); document.getElementById('finance-dashboard').classList.remove('hidden'); });

document.getElementById('ci-save').addEventListener('click', ()=>{
  const username=document.getElementById('ci-username').value.trim();
  const desc=document.getElementById('ci-desc').value.trim();
  const amount=Number(document.getElementById('ci-amount').value);
  const due=document.getElementById('ci-due').value;
  if(!username||!desc||!amount||!due){ alert('Preencha todos os campos'); return; }
  const users=getUsers(); const user = users.find(u=>u.username===username);
  if(!user){ alert('Usuário não encontrado. Crie-o em _DOCS ou use usuário de teste: cliente'); return; }
  const invoices = getInvoices();
  const inv = { id: uid(), appointment_id: null, user_id: user.id, username: user.username, description:desc, total: Number(amount).toFixed(2), status:'issued', issued_at: new Date().toISOString(), due_date: due };
  invoices.push(inv); saveInvoices(invoices); alert('Fatura criada: '+inv.id); hideAll(); document.getElementById('finance-dashboard').classList.remove('hidden'); renderInvoicesTable(); renderStats();
});

// Render tabela de invoices
function renderInvoicesTable(){ const tbody = document.querySelector('#table-invoices tbody'); tbody.innerHTML=''; const invoices=getInvoices(); invoices.forEach(inv=>{
  const tr = document.createElement('tr');
  tr.innerHTML = `<td>${inv.id}</td><td>${inv.username||''}</td><td>${formatBR(inv.total)}</td><td>${inv.status}</td><td>${inv.due_date}</td><td>
    <button class="btn ghost" data-id="${inv.id}" onclick="openInvoice('${inv.id}')">Abrir</button>
    ${inv.status!=='paid'? `<button class='btn' onclick="markPaidConfirm('${inv.id}')">Marcar pago</button>`:''}
  </td>`;
  tbody.appendChild(tr);
});}

window.openInvoice = function(id){ const inv = getInvoices().find(i=>i.id===id); if(!inv) return alert('Fatura não encontrada'); hideAll(); document.getElementById('view-invoice').classList.remove('hidden'); document.getElementById('vi-id').innerText = id; document.getElementById('vi-body').innerHTML = `
  <div><strong>Cliente:</strong> ${inv.username}</div>
  <div><strong>Descrição:</strong> ${inv.description}</div>
  <div><strong>Valor:</strong> ${formatBR(inv.total)}</div>
  <div><strong>Emitida:</strong> ${new Date(inv.issued_at).toLocaleString()}</div>
  <div><strong>Vencimento:</strong> ${inv.due_date}</div>
  <div><strong>Status:</strong> ${inv.status}</div>
`;
}

// Registrar pagamento (simulado)
window.markPaidConfirm = function(id){ if(!confirm('Marcar fatura '+id+' como paga?')) return; const method = prompt('Método de pagamento (cartao, boleto, pix, dinheiro)', 'pix') || 'pix'; registerPayment(id, method, null); }

function registerPayment(invoiceId, method, reference){ const invoices = getInvoices(); const inv = invoices.find(i=>i.id===invoiceId); if(!inv) return alert('Fatura não encontrada');
  const payments = getPayments();
  const pay = { id: uid(), invoice_id: invoiceId, method, amount: Number(inv.total).toFixed(2), paid_at: new Date().toISOString(), reference: reference||('REF-'+uid()) };
  payments.push(pay); savePayments(payments);
  // atualizar invoice
  inv.status='paid'; saveInvoices(invoices);
  alert('Pagamento registrado. Comprovante: '+pay.reference);
  renderInvoicesTable(); renderStats();
}

document.getElementById('vi-pay').addEventListener('click', ()=>{
  const id = document.getElementById('vi-id').innerText; const method = document.getElementById('vi-method').value; registerPayment(id, method, null);
});

// Imprimir comprovante (gera área de impressão temporária)
document.getElementById('vi-print').addEventListener('click', ()=>{
  const id = document.getElementById('vi-id').innerText; const inv = getInvoices().find(i=>i.id===id);
  if(!inv) return alert('Fatura não encontrada');
  const payments = getPayments().filter(p=>p.invoice_id===id);
  const last = payments[payments.length-1] || null;
  const html = `
    <div style="font-family:Arial;padding:20px;">
      <h2>Comprovante de Pagamento - Pet Serviços Zezé</h2>
      <p><strong>Fatura:</strong> ${inv.id}</p>
      <p><strong>Cliente:</strong> ${inv.username}</p>
      <p><strong>Descrição:</strong> ${inv.description}</p>
      <p><strong>Valor:</strong> ${formatBR(inv.total)}</p>
      <p><strong>Status:</strong> ${inv.status}</p>
      ${ last ? `<p><strong>Pago em:</strong> ${new Date(last.paid_at).toLocaleString()} - <strong>Método:</strong> ${last.method} - <strong>Ref:</strong> ${last.reference}</p>` : '<p><em>Sem pagamento registrado</em></p>' }
      <hr>
      <p class="small">Documento gerado em ${new Date().toLocaleString()}</p>
    </div>
  `;
  const w = window.open('','_blank'); w.document.write(html); w.document.close();
});

// Export CSV (faturas)
document.getElementById('btn-export-csv').addEventListener('click', ()=>{
  const invoices = getInvoices(); if(!invoices.length) return alert('Sem faturas');
  const rows = ['id;username;description;total;status;due_date'];
  invoices.forEach(i=> rows.push([i.id,i.username,i.description,i.total,i.status,i.due_date].join(';')));
  const csv = rows.join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='faturas.csv'; a.click(); URL.revokeObjectURL(url);
});

// Render estatísticas
function renderStats(){ const invoices = getInvoices(); let revenue=0, expense=0; const payments = getPayments(); payments.forEach(p=> revenue += Number(p.amount)); // receita
  // despesas poderiam ser registradas em tabela separada (no futuro)
  document.getElementById('stat-revenue').innerText = formatBR(revenue);
  document.getElementById('stat-expense').innerText = formatBR(expense);
  document.getElementById('stat-balance').innerText = formatBR(revenue - expense);
}

// Inicial render
hideAll(); document.getElementById('home').classList.remove('hidden');

</script>
</body>
</html>
